---
title: '使用 Windows 批处理脚本一键切换带绕过列表的代理'
pubDate: 2025-08-06T00:00:00.000Z
description: '本教程介绍如何利用 Windows 批处理脚本自动化管理 WinHTTP 代理设置，包含自动获取管理员权限及设置绕过列表等高级技巧。'
author: 'Remy'
tags: ['windows', '代理', '脚本']
---

## Windows 批处理脚本配置本地代理深度指南

如果你是开发者、IT 专业人士或高级用户，是否曾因为繁琐的 Windows 网络设置管理而头疼？无论是在开发调试时需要通过特定程序路由流量，还是某些软件需要自定义代理配置，在 Windows 菜单中反复手动修改既低效又容易出错。

幸运的是，我们可以通过一个简单而强大的批处理脚本将这一过程完全自动化。

在本指南中，我们将深度解析一个自动配置 WinHTTP 代理设置的脚本，详细说明其核心逻辑，并教你如何根据实际需求进行自定义。

### 脚本功能核心逻辑

该脚本主要实现以下三个关键操作：

1. **自动获取管理员权限：** 修改系统级的网络设置需要提升权限。脚本巧妙地实现了自动请求管理员权限的功能，运行即触发 UAC 提示，无需手动右键。
2. **配置系统代理：** 将 Windows 流量定向至本地（`localhost`）代理服务器。这对于使用抓包工具或代理软件监控、调试网络请求至关重要。
3. **精细化定义绕过列表（Bypass List）：** 并非所有流量都需要走代理。通过设置“绕过列表”，可以确保本地站点、特定国内域名或后台服务不受代理干扰，直接连接。

### 脚本源码

你可以将以下代码保存为 `.bat` 文件（如 `proxy_config.bat`）直接使用。

```batch
@echo off
:Get Admin Access
%1 mshta vbscript:CreateObject("Shell.Application").ShellExecute("cmd.exe","/c %~s0 ::","","runas",1)(window.close)&&exit

netsh winhttp set proxy localhost:15236 bypass-list="<local>;*.cn;*.localsite.com"

pause
```

### 深度解析：代码逐行说明

#### 1. `@echo off`
这是批处理脚本的标准开头，用于关闭命令回显，让输出界面更整洁，只显示运行结果而非命令本身。

#### 2. 权限提升技巧：`%1 mshta ...`
这一行是脚本的精华所在。它利用 Windows 内置的 `mshta.exe` 调用 VBScript，通过 `runas` 动词触发 UAC 提权提示。
- 如果当前不是管理员，它会拉起一个新的具有管理员权限的 CMD 窗口。
- 如果已经是管理员权限，则会继续执行后续命令。

#### 3. 核心设置：`netsh winhttp set proxy ...`
这是实现代理切换的核心命令：
- `netsh winhttp`：Windows 的网络命令行工具，用于配置 Windows HTTP 服务（WinHTTP）的设置。
- `localhost:15236`：指定代理服务器地址。这里设置为本地端口 `15236`。
- `bypass-list="..."`：定义不使用代理的例外规则：
    - `<local>`：自动绕过所有简单的内部名称（如局域网内的文件服务器）。
    - `*.cn`：绕过所有 `.cn` 结尾的中国域名，保证国内访问速度。
    - `*.localsite.com`：你可以根据需要添加特定的开发环境域名。

#### 4. `pause`
脚本执行完毕后暂停，防止窗口立即关闭，方便你查看执行结果或错误提示。

### 如何根据需求自定义

你可以轻松修改此脚本以适应不同的开发环境：

*   **修改端口号：** 将 `15236` 更改为你的代理软件端口（例如 Clash 常用的 `7890`，Fiddler 默认的 `8888`）。
*   **编辑绕过规则：** 在 `bypass-list` 字符串中添加或删除域名，多个规则之间用分号 (`;`) 分隔。

通过这个简单的脚本，你可以将复杂的网络配置简化为双击一次，极大地提升开发效率和网络管理的灵活性。
