---
// Component Imports
import '../styles/global.css';
import 'katex/dist/katex.min.css';
import LanguageToggle from '../components/LanguageToggle.astro';
import AntiAdblock from '../components/AntiAdblock.astro';
import {
  detectLanguageFromPath,
  t,
  getCanonicalURL,
  getHreflangAlternates,
  getLocaleString,
  getLanguageCode,
  getLocalizedPath
} from '../utils/i18n';

// Component Script:
const currentLang = detectLanguageFromPath(Astro.url.pathname);
const {
    title = t('home', currentLang) + " - Redreamality's Blog",
    description = currentLang === 'zh' ? "欢迎访问 Redreamality 的个人博客，这里汇集了关于软件开发、AI 智能体及各类技术创新项目的深度文章与实践经验。" : currentLang === 'ja' ? "Redreamalityのブログへようこそ。ソフトウェア開発、AIエージェント、最新テクノロジーに関する詳細な記事やプロジェクトの成果を公開しています。" : "Explore Redreamality's personal blog and project showcase, featuring in-depth articles on software development, AI agents, and innovative technology solutions.",
    image = "/images/default-og.png",
    canonicalURL = getCanonicalURL(Astro.url.pathname, currentLang, Astro.site.toString()),
    type = "website",
    publishDate,
    tags = [],
    author = "Redreamality"
} = Astro.props;

const socialImageURL = new URL(image, Astro.site);
const hreflangAlternates = getHreflangAlternates(Astro.url.pathname, Astro.site.toString());
const localeString = getLocaleString(currentLang);
const languageCode = getLanguageCode(currentLang);

const normalizePath = (path: string) => (path.length > 1 ? path.replace(/\/$/, '') : path);
const normalizedPath = normalizePath(Astro.url.pathname);
const isTagPage =
  normalizedPath === '/tags' ||
  normalizedPath.startsWith('/tags/') ||
  normalizedPath === '/cn/tags' ||
  normalizedPath.startsWith('/cn/tags/') ||
  normalizedPath === '/ja/tags' ||
  normalizedPath.startsWith('/ja/tags/');

const ensureTrailingSlash = (path: string) => (path === '/' ? '/' : path.endsWith('/') ? path : `${path}/`);

const homeHref = ensureTrailingSlash(getLocalizedPath('/', currentLang));
const blogHref = getLocalizedPath('/blog/', currentLang);
const talksHref = getLocalizedPath('/garden/talks/', currentLang);
const questionsHref = getLocalizedPath('/garden/questions/', currentLang);
const notesHref = getLocalizedPath('/garden/notes/', currentLang);
const projectsHref = getLocalizedPath('/projects/', currentLang);
const aboutHref = getLocalizedPath('/about/', currentLang);
---

<!DOCTYPE html>
<html lang={languageCode}>
    <head>
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-4WM6C44V4Z"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());

            gtag('config', 'G-4WM6C44V4Z');
        </script>
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4617864538353929"
             crossorigin="anonymous"></script>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="google-adsense-account" content="ca-pub-4617864538353929">

        <!-- Primary Meta Tags -->
        <title>{title}</title>
        <meta name="title" content={title} />
        <meta name="description" content={description} />
        <link rel="canonical" href={canonicalURL} />

        <!-- Hreflang Tags -->
        {hreflangAlternates.map(({ lang, url }) => (
            <link rel="alternate" hreflang={lang} href={url} />
        ))}
        <link rel="alternate" hreflang="x-default" href={hreflangAlternates.find(alt => alt.lang === 'en')?.url} />
        
        <!-- RSS Feeds -->
        <link rel="alternate" type="application/rss+xml" title="RSS Feed (English)" href="/rss.xml" />
        <link rel="alternate" type="application/rss+xml" title="RSS Feed (中文)" href="/cn/rss.xml" />
        <link rel="alternate" type="application/rss+xml" title="RSS Feed (日本語)" href="/ja/rss.xml" />
        
        <!-- Open Graph / Facebook -->
        <meta property="og:type" content={type} />
        <meta property="og:url" content={canonicalURL} />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={description} />
        <meta property="og:image" content={socialImageURL} />
        <meta property="og:site_name" content="Redreamality's Blog" />
        <meta property="og:locale" content={localeString} />
        {publishDate && <meta property="article:published_time" content={publishDate} />}
        {tags.map((tag) => (
            <meta property="article:tag" content={tag} />
        ))}
        
        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:url" content={canonicalURL} />
        <meta property="twitter:title" content={title} />
        <meta property="twitter:description" content={description} />
        <meta property="twitter:image" content={socialImageURL} />
        <meta name="twitter:creator" content="@redreamality" />
        
        <!-- Other Meta Tags -->
        <meta name="generator" content={Astro.generator} />
        <meta name="google-site-verification" content="NxVlZ1d8Bmz-k4XFi54AbYDxS-5atIJjnfGXeEC3eVg" />
        <meta name="robots" content="index, follow, max-image-preview:large" />
        <meta name="author" content={author} />
        <meta name="keywords" content={tags.join(', ')} />
        
        <!-- JSON-LD -->
        <script type="application/ld+json" set:html={JSON.stringify({
            "@context": "https://schema.org",
            "@type": type === "article" ? "BlogPosting" : "WebSite",
            "headline": title,
            "description": description,
            "image": socialImageURL.toString(),
            "url": canonicalURL.toString(),
            "author": {
                "@type": "Person",
                "name": author,
                "url": new URL("/about/", Astro.site).toString()
            },
            "publisher": {
                "@type": "Organization",
                "name": "Redreamality's Blog",
                "url": Astro.site.toString()
            },
            "mainEntityOfPage": {
                "@type": "WebPage",
                "@id": canonicalURL.toString()
            },
            "datePublished": type === "article" && publishDate ? publishDate : undefined,
            "keywords": type === "article" && publishDate ? tags.join(', ') : undefined,
            "inLanguage": languageCode
        })} />
        <script>
            (function(d,t) {
                var BASE_URL="https://app.chatwoot.com";
                var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
                g.src=BASE_URL+"/packs/js/sdk.js";
                g.defer = true;
                g.async = true;
                s.parentNode.insertBefore(g,s);
                g.onload=function(){
                window.chatwootSDK.run({
                    websiteToken: 'WB6uJVyRDCugKzacNwRs6bEA',
                    baseUrl: BASE_URL
                })
                }
            })(document,"script");
        </script>
    </head>
    <body class="min-h-screen bg-white dark:bg-gray-900 flex flex-col">
        <nav class="bg-white border-gray-200 dark:bg-gray-900 fixed top-0 left-0 w-full z-50">
            <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
                <a href={homeHref} class="flex items-center space-x-3 rtl:space-x-reverse">
                    <span class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white">Remy's Blog</span>
                </a>
                <button data-collapse-toggle="navbar-default" type="button" class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="navbar-default" aria-expanded="false" id="mobile-menu-button">
                    <span class="sr-only">Open main menu</span>
                    <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 17 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1h15M1 7h15M1 13h15"/>
                    </svg>
                </button>
                <div class="hidden w-full md:block md:w-auto" id="navbar-default">
                    <ul class="font-medium flex flex-col p-4 md:p-0 mt-4 border border-gray-100 rounded-lg bg-gray-50 md:flex-row md:space-x-8 rtl:space-x-reverse md:mt-0 md:border-0 md:bg-white dark:bg-gray-800 md:dark:bg-gray-900 dark:border-gray-700">
                        <li><a href={homeHref} class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent">{t('home', currentLang)}</a></li>
                        <li class="relative group">
                            <button id="garden-menu-toggle" class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent flex items-center w-full text-left">
                                {t('garden', currentLang)}
                                <svg class="w-2.5 h-2.5 ms-2.5 garden-chevron transition-transform duration-200" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                                </svg>
                            </button>
                            <div id="garden-dropdown" class="nav-dropdown-mobile hidden absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg dark:bg-gray-800 z-50 md:hidden">
                                <ul class="py-2 text-sm text-gray-700 dark:text-gray-200">
                                    <li>
                                        <a href={blogHref} class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 dark:hover:text-white">{t('blog', currentLang)}</a>
                                    </li>
                                    <li>
                                        <a href={talksHref} class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 dark:hover:text-white">{t('talks', currentLang)}</a>
                                    </li>
                                    <li>
                                        <a href={questionsHref} class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 dark:hover:text-white">{t('questions', currentLang)}</a>
                                    </li>
                                    <li>
                                        <a href={notesHref} class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 dark:hover:text-white">{t('notes', currentLang)}</a>
                                    </li>
                                </ul>
                            </div>
                            <div class="nav-dropdown-desktop absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg dark:bg-gray-800 z-50 hidden md:block">
                                <ul class="py-2 text-sm text-gray-700 dark:text-gray-200">
                                    <li>
                                        <a href={blogHref} class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 dark:hover:text-white">{t('blog', currentLang)}</a>
                                    </li>
                                    <li>
                                        <a href={talksHref} class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 dark:hover:text-white">{t('talks', currentLang)}</a>
                                    </li>
                                    <li>
                                        <a href={questionsHref} class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 dark:hover:text-white">{t('questions', currentLang)}</a>
                                    </li>
                                    <li>
                                        <a href={notesHref} class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 dark:hover:text-white">{t('notes', currentLang)}</a>
                                    </li>
                                </ul>
                            </div>
                        </li>
                        <li><a href={projectsHref} class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent">{t('projects', currentLang)}</a></li>
                        <li><a href={aboutHref} class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent">{t('about', currentLang)}</a></li>
                        {!isTagPage && (
                            <li class="md:hidden"><LanguageToggle currentPath={Astro.url.pathname} instanceId="mobile" /></li>
                        )}
                    </ul>
                </div>
                {!isTagPage && (
                    <div class="hidden md:block">
                        <LanguageToggle currentPath={Astro.url.pathname} instanceId="desktop" />
                    </div>
                )}
            </div>
        </nav>
        <main class="container mx-auto px-4 py-8 flex-grow mt-16">
            <slot />
        </main>
        <footer class="bg-white dark:bg-gray-900 mt-auto">
            <div class="w-full max-w-screen-xl mx-auto p-4 md:py-8">
                <div class="flex flex-col items-center justify-center space-y-2">
                    <span class="block text-sm text-gray-500 dark:text-gray-400">© {new Date().getFullYear()}. All Rights Reserved.</span>
                    <div class="flex flex-col items-center space-y-1">
                        <a href="/sitemap-0.xml" class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">Sitemap</a>
                        <div class="flex flex-wrap justify-center gap-x-4 gap-y-1">
                            <a href="/rss.xml" class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
                                RSS Feed (English)
                            </a>
                            <a href="/cn/rss.xml" class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
                                RSS Feed (中文)
                            </a>
                            <a href="/ja/rss.xml" class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
                                RSS Feed (日本語)
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
        <AntiAdblock />
        <script>
            const siteHeader = document.querySelector('body > nav');

            const setHeaderHeightVar = () => {
                const height = siteHeader?.getBoundingClientRect().height ?? 0;
                if (height > 0) {
                    document.documentElement.style.setProperty('--site-header-height', `${height}px`);
                }
            };

            const scrollToAnchorWithOffset = (anchorId, behavior) => {
                const el = document.getElementById(anchorId);
                if (!el) return false;

                const headerHeight = siteHeader?.getBoundingClientRect().height ?? 0;
                const top = Math.max(0, el.getBoundingClientRect().top + window.scrollY - headerHeight - 16);
                window.scrollTo({ top, behavior });
                return true;
            };

            setHeaderHeightVar();
            window.addEventListener('resize', setHeaderHeightVar);

            const safeDecodeURIComponent = (value) => {
                try {
                    return decodeURIComponent(value);
                } catch {
                    return value;
                }
            };

            const initialHash = window.location.hash ? safeDecodeURIComponent(window.location.hash.slice(1)) : '';
            if (initialHash) {
                requestAnimationFrame(() => {
                    scrollToAnchorWithOffset(initialHash, 'auto');
                });
            }

            document.addEventListener('click', (e) => {
                if (
                    e.defaultPrevented ||
                    e.button !== 0 ||
                    e.metaKey ||
                    e.ctrlKey ||
                    e.shiftKey ||
                    e.altKey
                ) {
                    return;
                }

                const target = e.target;
                if (!(target instanceof Element)) return;

                const link = target.closest('a[href^="#"]');
                if (!link) return;

                const href = link.getAttribute('href');
                if (!href || href === '#') return;

                const id = safeDecodeURIComponent(href.slice(1));
                if (!scrollToAnchorWithOffset(id, 'smooth')) return;

                e.preventDefault();

                if (window.location.hash !== href) {
                    history.pushState(null, '', href);
                } else {
                    history.replaceState(null, '', href);
                }
            });

            window.addEventListener('hashchange', () => {
                const id = window.location.hash ? safeDecodeURIComponent(window.location.hash.slice(1)) : '';
                if (!id) return;
                requestAnimationFrame(() => {
                    scrollToAnchorWithOffset(id, 'smooth');
                });
            });

            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const navbarDefault = document.getElementById('navbar-default');
            const gardenMenuToggle = document.getElementById('garden-menu-toggle');
            const gardenDropdown = document.getElementById('garden-dropdown');

            if (mobileMenuButton && navbarDefault) {
                mobileMenuButton.addEventListener('click', () => {
                    navbarDefault.classList.toggle('hidden');
                    const isExpanded = mobileMenuButton.getAttribute('aria-expanded') === 'true';
                    mobileMenuButton.setAttribute('aria-expanded', !isExpanded);
                });
            }

            if (gardenMenuToggle && gardenDropdown) {
                let gardenDropdownOpen = false;

                gardenMenuToggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    gardenDropdownOpen = !gardenDropdownOpen;

                    if (gardenDropdownOpen) {
                        gardenDropdown.classList.remove('hidden');
                        gardenDropdown.style.opacity = '1';
                        gardenDropdown.style.visibility = 'visible';
                        gardenMenuToggle.querySelector('.garden-chevron').classList.add('rotate-180');
                    } else {
                        gardenDropdown.classList.add('hidden');
                        gardenDropdown.style.opacity = '0';
                        gardenDropdown.style.visibility = 'hidden';
                        gardenMenuToggle.querySelector('.garden-chevron').classList.remove('rotate-180');
                    }
                });
            }
        </script>
    </body>
</html>


<style>
    html,
    body {
        margin: 0;
        width: 100%;
        min-height: 100vh;
    }

    .nav-dropdown-desktop {
        opacity: 0;
        visibility: hidden;
        transition:
            opacity 300ms ease 500ms,
            visibility 0s linear 800ms;
    }

    .group:hover .nav-dropdown-desktop {
        opacity: 1;
        visibility: visible;
        transition:
            opacity 300ms ease 0ms,
            visibility 0s linear 0ms;
    }

    .garden-chevron.rotate-180 {
        transform: rotate(180deg);
    }
</style>
