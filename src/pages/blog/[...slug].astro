---
import Layout from '../../layouts/Layout.astro';
import { getBlogPosts, getLocalizedContent, t, type Language } from '../../utils/i18n';
import TableOfContents from '../../components/TableOfContents.astro';

export async function getStaticPaths() {
  const paths = [];

  // Get all blog posts for both languages
  const enPosts = await getBlogPosts('en');
  const zhPosts = await getBlogPosts('zh');

  // Generate English paths (root)
  for (const post of enPosts) {
    paths.push({
      params: { slug: post.slug },
      props: { post, lang: 'en' }
    });
  }

  // Generate Chinese paths (/cn/)
  for (const post of zhPosts) {
    paths.push({
      params: { slug: `cn/${post.slug}` },
      props: { post, lang: 'zh' }
    });
  }

  return paths;
}

interface Props {
  post: any;
  lang: Language;
}

const { post, lang } = Astro.props;
const { Content, headings } = await post.render();

// Language-specific content
const content = {
  en: {
    backToBlog: "Back to Blog",
    publishedOn: "Published on",
    updatedOn: "Updated on",
    author: "Author",
    readingTime: "min read",
    tags: "Tags"
  },
  zh: {
    backToBlog: "è¿”å›åšå®¢åˆ—è¡¨",
    publishedOn: "å‘å¸ƒäº",
    updatedOn: "æ›´æ–°äº",
    author: "ä½œè€…",
    readingTime: "åˆ†é’Ÿé˜…è¯»",
    tags: "æ ‡ç­¾"
  }
};

const currentContent = content[lang];
const basePath = lang === 'zh' ? '/cn' : '';

// Prepare SEO metadata
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const articleImage = post.data.image || '/images/default-blog-image.png';
const description = post.data.description || (lang === 'zh' ? `é˜…è¯»æ–‡ç« ï¼š${post.data.title}` : `Read article: ${post.data.title}`);

// å‡†å¤‡ç»“æ„åŒ–æ•°æ®
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": post.data.title,
  "description": description,
  "image": articleImage,
  "author": {
    "@type": "Person",
    "name": post.data.author
  },
  "datePublished": post.data.pubDate.toISOString(),
  "dateModified": post.data.updatedDate?.toISOString() || post.data.pubDate.toISOString(),
  "keywords": post.data.tags?.join(", "),
  "url": canonicalURL.toString(),
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": canonicalURL.toString()
  }
};
---

<Layout 
  title={`${post.data.title} | Redreamality's Blog`}
  description={description}
  image={articleImage}
  canonicalURL={canonicalURL}
  type="article"
  publishDate={post.data.pubDate.toISOString()}
  tags={post.data.tags || []}
  author={post.data.author}
>
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
  
  <main class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto relative">
      <div class="mb-8">
        <a
          href={`${basePath}/blog`}
          class="inline-flex items-center text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300"
        >
          <span class="mr-2">â†</span>
          {currentContent.backToBlog}
        </a>
      </div>

      <TableOfContents headings={headings} />

      <article class="max-w-3xl bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8">
        <header>
          <h1 class="text-4xl font-bold mb-6">{post.data.title}</h1>
          
          <div class="flex flex-wrap gap-4 text-sm text-gray-500 dark:text-gray-400 mb-8">
            <time datetime={post.data.pubDate.toISOString()}>
              <span class="mr-2">ğŸ“…</span>
              {post.data.pubDate.toLocaleDateString(lang === 'zh' ? 'zh-CN' : 'en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              })}
            </time>
            {post.data.updatedDate && (
              <time datetime={post.data.updatedDate.toISOString()}>
                <span class="mr-2">ğŸ”„</span>
                {currentContent.updatedOn}: {post.data.updatedDate.toLocaleDateString(lang === 'zh' ? 'zh-CN' : 'en-US', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric'
                })}
              </time>
            )}
            <div>
              <span class="mr-2">âœï¸</span>
              {currentContent.author}: {post.data.author}
            </div>
            {post.data.tags && (
              <div class="flex gap-2">
                <span class="mr-2">ğŸ·ï¸</span>
                {post.data.tags.map((tag: string) => (
                  <a
                    href={`${basePath}/tags/${tag}`}
                    class="hover:text-blue-600 dark:hover:text-blue-400"
                  >
                    #{tag}
                  </a>
                ))}
              </div>
            )}
          </div>
        </header>

        <article class="prose dark:prose-invert max-w-none">
          <Content />
        </article>
      </article>
    </div>
  </main>
</Layout>

<script>
  // æ·»åŠ å¹³æ»‘æ»šåŠ¨æ•ˆæœå’Œåç§»é‡å¤„ç†
  document.addEventListener('DOMContentLoaded', () => {
    // è®¾ç½®é¡¶éƒ¨åç§»é‡ï¼ˆå¯¼èˆªæ é«˜åº¦ + é¢å¤–ç©ºé—´ï¼‰
    const SCROLL_OFFSET = 100;

    // å¤„ç†ç›®å½•ç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.table-of-contents a').forEach(anchor => {
      anchor.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = anchor.getAttribute('href')?.slice(1);
        if (targetId) {
          const targetElement = document.getElementById(targetId);
          if (targetElement) {
            // è·å–ç›®æ ‡å…ƒç´ çš„ä½ç½®
            const targetPosition = targetElement.getBoundingClientRect().top;
            const offsetPosition = targetPosition + window.pageYOffset - SCROLL_OFFSET;

            // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡ä½ç½®
            window.scrollTo({
              top: offsetPosition,
              behavior: 'smooth'
            });

            // æ›´æ–° URLï¼Œä½†ä¸è§¦å‘æ»šåŠ¨
            history.pushState(null, '', `#${targetId}`);
          }
        }
      });
    });

    // å¤„ç†ç›´æ¥é€šè¿‡ URL hash è·³è½¬çš„æƒ…å†µ
    window.addEventListener('load', () => {
      if (location.hash) {
        setTimeout(() => {
          const targetElement = document.getElementById(location.hash.slice(1));
          if (targetElement) {
            const targetPosition = targetElement.getBoundingClientRect().top;
            const offsetPosition = targetPosition + window.pageYOffset - SCROLL_OFFSET;
            window.scrollTo({
              top: offsetPosition,
              behavior: 'smooth'
            });
          }
        }, 0);
      }
    });

    // ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œé«˜äº®å½“å‰å¯è§çš„æ ‡é¢˜
    let headings = Array.from(document.querySelectorAll('h1, h2, h3, h4, h5, h6'))
      .filter(heading => heading.id); // åªé€‰æ‹©æœ‰ id çš„æ ‡é¢˜

    let tocLinks = document.querySelectorAll('.table-of-contents a');
    
    function highlightTableOfContents() {
      if (headings.length === 0) return;

      // æ‰¾åˆ°å½“å‰å¯è§çš„æ ‡é¢˜
      let current = headings[0];
      for (const heading of headings) {
        const rect = heading.getBoundingClientRect();
        if (rect.top <= SCROLL_OFFSET + 50) {
          current = heading;
        } else {
          break;
        }
      }

      // ç§»é™¤æ‰€æœ‰é«˜äº®
      tocLinks.forEach(link => {
        link.classList.remove('text-blue-600', 'dark:text-blue-400');
        link.classList.add('hover:text-blue-600', 'dark:hover:text-blue-400');
      });

      // æ·»åŠ å½“å‰æ ‡é¢˜çš„é«˜äº®
      const currentLink = document.querySelector(`.table-of-contents a[href="#${current.id}"]`);
      if (currentLink) {
        currentLink.classList.add('text-blue-600', 'dark:text-blue-400');
        currentLink.classList.remove('hover:text-blue-600', 'dark:hover:text-blue-400');
      }
    }

    // æ·»åŠ æ»šåŠ¨ç›‘å¬
    window.addEventListener('scroll', highlightTableOfContents, { passive: true });
  });
</script> 